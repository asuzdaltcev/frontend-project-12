# Тестирование валидации уникальности имен каналов

## Обзор

В приложении реализована комплексная валидация уникальности имен каналов, которая включает:

1. **Клиентскую валидацию** - проверка на фронтенде с помощью Yup
2. **Серверную валидацию** - обработка ошибок с сервера
3. **Нормализацию данных** - удаление пробелов и приведение к нижнему регистру

## Функциональность

### Валидация при добавлении канала

- Проверка минимальной длины (3 символа)
- Проверка максимальной длины (20 символов)
- Проверка уникальности имени (без учета регистра)
- Удаление лишних пробелов
- Обработка ошибок с сервера

### Валидация при переименовании канала

- Все те же проверки, что и при добавлении
- Исключение текущего канала из проверки уникальности
- Сохранение исходного имени, если новое имя совпадает с текущим

## Сценарии тестирования

### 1. Добавление канала с дублирующим именем

**Шаги:**
1. Откройте приложение и войдите в систему
2. Нажмите кнопку "+" рядом с заголовком "Каналы"
3. Введите имя существующего канала (например, "general")
4. Нажмите "Добавить"

**Ожидаемый результат:**
- Появится ошибка "Канал с таким именем уже существует"
- Форма не отправится
- Кнопка "Добавить" останется активной

### 2. Добавление канала с именем в другом регистре

**Шаги:**
1. Попробуйте добавить канал "GENERAL" (если уже есть "general")
2. Попробуйте добавить канал "General" (если уже есть "general")

**Ожидаемый результат:**
- Ошибка "Канал с таким именем уже существует"
- Валидация не учитывает регистр

### 3. Добавление канала с пробелами

**Шаги:**
1. Попробуйте добавить канал "  general  " (с пробелами)
2. Попробуйте добавить канал "general " (с пробелом в конце)

**Ожидаемый результат:**
- Если канал "general" уже существует, появится ошибка
- Пробелы автоматически удаляются при отправке

### 4. Переименование канала в существующее имя

**Шаги:**
1. Откройте выпадающее меню канала "general"
2. Выберите "Переименовать"
3. Введите имя другого существующего канала
4. Нажмите "Переименовать"

**Ожидаемый результат:**
- Ошибка "Канал с таким именем уже существует"
- Форма не отправится

### 5. Переименование канала в то же имя

**Шаги:**
1. Откройте выпадающее меню канала "general"
2. Выберите "Переименовать"
3. Оставьте то же имя "general"
4. Нажмите "Переименовать"

**Ожидаемый результат:**
- Операция должна пройти успешно
- Канал останется с тем же именем

### 6. Переименование канала в имя с пробелами

**Шаги:**
1. Переименуйте канал в "  new name  "
2. Проверьте, как отображается имя в списке

**Ожидаемый результат:**
- Имя должно отображаться как "new name" (без лишних пробелов)

### 7. Добавление канала с граничными значениями

**Шаги:**
1. Попробуйте добавить канал с именем из 2 символов
2. Попробуйте добавить канал с именем из 21 символа
3. Попробуйте добавить канал с пустым именем

**Ожидаемый результат:**
- Ошибка "Минимум 3 символа" для коротких имен
- Ошибка "Максимум 20 символов" для длинных имен
- Ошибка "Обязательное поле" для пустого имени

### 8. Тестирование с WebSocket

**Шаги:**
1. Откройте приложение в двух браузерах
2. В первом браузере добавьте новый канал
3. Во втором браузере попробуйте добавить канал с тем же именем

**Ожидаемый результат:**
- Во втором браузере должна появиться ошибка о дублировании
- WebSocket должен синхронизировать список каналов

## Технические детали

### Валидация Yup

```javascript
const validationSchema = Yup.object().shape({
  name: Yup.string()
    .min(3, 'Минимум 3 символа')
    .max(20, 'Максимум 20 символов')
    .required('Обязательное поле')
    .trim()
    .test('unique', 'Канал с таким именем уже существует', function(value) {
      if (!value) return true;
      const channels = this.options.context?.channels || [];
      const normalizedValue = value.trim().toLowerCase();
      return !channels.some(channel => 
        channel.name.trim().toLowerCase() === normalizedValue
      );
    }),
});
```

### Обработка ошибок сервера

```javascript
catch (error) {
  if (error?.message?.includes('уже существует') || error?.message?.includes('already exists')) {
    setFieldError('name', 'Канал с таким именем уже существует');
  } else {
    setFieldError('name', error?.message || 'Ошибка при добавлении канала');
  }
}
```

### Нормализация данных

```javascript
const normalizedName = values.name.trim();
await dispatch(addChannel(normalizedName)).unwrap();
```

## Возможные проблемы и решения

### Проблема: Валидация не срабатывает в реальном времени

**Решение:** Проверьте, что в Formik передается правильный контекст с каналами

### Проблема: Ошибки сервера не отображаются

**Решение:** Убедитесь, что в catch блоке используется setFieldError

### Проблема: Валидация не учитывает регистр

**Решение:** Проверьте, что в тесте используется toLowerCase()

## Команды для тестирования

```bash
# Запуск фронтенда
cd frontend && npm run dev

# Запуск сервера (в другом терминале)
npm start

# Проверка сборки
make build
```

## Заключение

Валидация уникальности имен каналов работает на двух уровнях:
1. **Клиентском** - для быстрого отклика пользователю
2. **Серверном** - для надежной проверки данных

Это обеспечивает хороший пользовательский опыт и надежность системы. 